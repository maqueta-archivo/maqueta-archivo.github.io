<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.5/dist/mindar-image.prod.js"></script>
  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.5/dist/mindar-image-aframe.prod.js"></script>
</head>

<body>
  <a-scene id="scene" mindar-image="imageTargetSrc: ./targets_pict.mind; filterMinCF:0.0001; filterBeta: 1000" color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    stats >
    <a-assets>
      <a-asset-item id="pamplonaModelObj" src="./Pamplona_3D_V01.obj"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0">
      <a-obj-model id="maqueta" rotation="105 0 0" position="0.4 5 1.5" scale="100 100 100" src="#pamplonaModelObj"
        material="src: ./Pamplona_3D_Color2.png; transparent: false; alphaTest: 0.6; wireframe: false; wireframeLinewidth: 2; offset: 0 0.5; emissiveIntensity: 1"></a-obj-model>
    </a-entity>
  </a-scene>
  
  <script>
    let last_time = Date.now();

    let offset_update = 0.6;
    let min_emissive = 0.3;
    let max_emissive = 0.65;
    let min_offset = -1;
    let max_offset = 1;

    function mapRange(current, in_min, in_max, out_min, out_max) {
      let scale = (out_max - out_min) / (in_max - in_min)
      let offset = -in_min * (out_max - out_min) / (in_max - in_min) + out_min
      return current * scale + offset
    }
    function updateShader() {
      let now = Date.now();
      let dt = (now - last_time) / 1000;
      last_time = now;

      if (document.getElementById("maqueta").components.material && document.getElementById("maqueta").components.material.material && document.getElementById("maqueta").components.material.material.map) {
        let new_offset = document.getElementById("maqueta").components.material.material.map.offset.y + offset_update * dt;

        if (new_offset >= max_offset) {
          new_offset = min_offset;
        }

        document.getElementById("maqueta").components.material.material.map.offset.y = new_offset;

        let new_emissive = 0;
        if (new_offset <= 0) {
          new_emissive = mapRange(new_offset, -1, 0, 0, 1);
        } else {
          new_emissive = mapRange(new_offset, 0, 1, 1, 0);
        }

        if (new_emissive > 1)
          new_emissive = 1;
        if (new_emissive < 0)
          new_emissive = 0;
        document.getElementById("maqueta").components.material.material.emissiveIntensity = new_emissive;
      }
      setTimeout(() => { updateShader(); }, 5);

    }
      setTimeout(() => { updateShader(); }, 5);
    
    //setTimeout(() => { document.getElementById("scene").components.inspector.openInspector(); }, 2000);
    
  </script>
</body>
</html>
